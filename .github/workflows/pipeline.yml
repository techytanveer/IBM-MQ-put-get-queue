name: IBM MQ C++ CI Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download and Install IBM MQ Client
        run: |
          # Download the MQ installer
          curl -LO https://public.dhe.ibm.com/ibmdl/export/pub/software/server/ibm-mq/mqad94/9.4.0.5-IBM-MQ-Install-Java-NoInstall-LinuxX64.tar.gz
          tar -zxvf 9.4.0.5-IBM-MQ-Install-Java-NoInstall-LinuxX64.tar.gz
          
          # Install core components only
          cd MQServer
          sudo ./mqlicense.sh -accept
          sudo dpkg -i ibmmq-runtime_9.4.0.5_amd64.deb ibmmq-client_9.4.0.5_amd64.deb ibmmq-sdk_9.4.0.5_amd64.deb

      - name: Compile
        run: |
          # Use full paths to ensure the compiler finds the MQ libraries
          g++ -I/opt/mqm/inc main.cpp -L/opt/mqm/lib64 -lmqm_r -o ibmMQ
          g++ -I/opt/mqm/inc get.cpp -L/opt/mqm/lib64 -lmqm_r -o mq_get

      - name: Setup and Run Functional Test
        run: |
          export PATH=$PATH:/opt/mqm/bin
          export LD_LIBRARY_PATH=/opt/mqm/lib64
          
          # 1. Create and Start the Queue Manager
          # We use sudo because the 'runner' user isn't in the 'mqm' group yet
          sudo crtmqm QM_CI
          sudo strmqm QM_CI
          
          # 2. Configure the Queue
          echo "DEFINE QLOCAL('TEST.QUEUE') REPLACE" | sudo runmqsc QM_CI
          
          # 3. Give the current user permission to access the MQ Objects
          # This is the "Magic Fix" for permission errors in CI
          sudo setmqaut -m QM_CI -t qmgr -p runner +all
          sudo setmqaut -m QM_CI -n TEST.QUEUE -t queue -p runner +all
          
          # 4. Run the demo programs
          ./ibmMQ
          RESULT=$(./mq_get)
          echo "$RESULT"
          
          if [[ "$RESULT" == *"Message Received"* ]]; then
            echo "CI Test Passed!"
          else
            echo "CI Test Failed!"
            exit 1
          fi
