name: IBM MQ C++ CI Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    container: 
      image: icr.io/ibm-messaging/mq:9.4.1.0-r1
      env:
        # This is the standard way to accept the license in IBM MQ containers
        LICENSE: accept
      options: --user root

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Compile Producer and Consumer
        run: |

          # 1. Install ONLY the compiler. No more curl/wget needed!
          microdnf install -y gcc-c++
          
          # 2. Verify the headers exist (sanity check)
          echo "Checking for vendored headers..."
          ls -R ./include
          
          # 3. Compile using the local headers
          g++ -I./include main.cpp -L/opt/mqm/lib64 -lmqm_r -o ibmMQ
          g++ -I./include get.cpp -L/opt/mqm/lib64 -lmqm_r -o mq_get

      - name: Setup and Run Functional Test
        run: |

          export LD_LIBRARY_PATH=/opt/mqm/lib64
          
          # 1. Setup MQ
          crtmqm QM1 && strmqm QM1
          echo "ALTER QMGR CHLAUTH(DISABLED) CONNAUTH(' ')" | runmqsc QM1
          echo "REFRESH QMGR TYPE(CONFIGEV)" | runmqsc QM1
          echo "DEFINE QLOCAL('TEST.QUEUE') REPLACE" | runmqsc QM1
          
          # 2. Start Consumer in the BACKGROUND
          # It will now wait up to 15 seconds for a message
          ./mq_get > consumer_output.txt &
          CONSUMER_PID=$!
          
          # 3. Wait a moment, then run the Producer
          sleep 2
          ./ibmMQ
          
          # 4. Wait for the consumer process to finish naturally
          wait $CONSUMER_PID
          
          # 5. Verify results
          RESULT=$(cat consumer_output.txt)
          echo "Final Consumer Output: $RESULT"

          if [[ "$RESULT" == *"Message Received"* ]]; then
             echo "Async Test Passed!"
          else
             echo "Async Test Failed!"
             exit 1
          fi
