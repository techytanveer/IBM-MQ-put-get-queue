name: IBM MQ C++ CI Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    container: 
      image: icr.io/ibm-messaging/mq:9.4.1.0-r1
      env:
        # This is the standard way to accept the license in IBM MQ containers
        LICENSE: accept
      options: --user root

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Compile Producer and Consumer
        run: |

          # 1. Install compiler and downloader
          microdnf install -y gcc-c++ curl
          
          # 2. Create a local include directory and download essential MQ headers
          mkdir -p ./include
          BASE_URL="https://raw.githubusercontent.com/ibm-messaging/mq-c-sample/master/include"
          
          # We need these three primary headers for standard MQ development
          curl -sL "$BASE_URL/cmqc.h" -o ./include/cmqc.h
          curl -sL "$BASE_URL/cmqxc.h" -o ./include/cmqxc.h
          curl -sL "$BASE_URL/cmqzc.h" -o ./include/cmqzc.h
          
          echo "Headers downloaded to ./include"
          
          # 3. Compile pointing to our new local include folder
          # We still use the library path /opt/mqm/lib64 which IS in the container
          g++ -I./include main.cpp -L/opt/mqm/lib64 -lmqm_r -o ibmMQ
          g++ -I./include get.cpp -L/opt/mqm/lib64 -lmqm_r -o mq_get

      - name: Setup and Run Functional Test
        run: |
          # Set the library path so the binary can find MQ libs
          export LD_LIBRARY_PATH=/opt/mqm/lib64
          
          # 1. Create and Start the Queue Manager
          crtmqm QM_CI
          strmqm QM_CI
          
          # 2. Configure the Queue
          echo "DEFINE QLOCAL('TEST.QUEUE') REPLACE" | runmqsc QM_CI
          
          # 3. Run the demo programs
          ./ibmMQ
          RESULT=$(./mq_get)
          echo "$RESULT"
          
          if [[ "$RESULT" == *"Message Received"* ]]; then
            echo "CI Test Passed!"
          else
            echo "CI Test Failed!"
            exit 1
          fi
